// by 6Harmonics Qige @ 2017.02.18 - 2017.03.29
var store={mode:"demo",debug:0,invalid:-999,offlineCounter:0,offlineCounterBar:6,defaultRecordQty:200,flot:{fields:"dfl",intl:{local:{instant:null,delayed:null},peers:[],DEMO:null},color:["blue","lime","red","purple","deep-purple","indigo","pink","light-blue","cyan","teal","green","light-green","yellow","amber","orange","deep-orange","brown","grey","blue-grey"],chart:[],chart_chscan:null},query:null,query_last:null,delayed:null,history:{local:{snr:[],br:[],eth_tx_thrpt:[],eth_rx_thrpt:[],wls_tx_thrpt:[],wls_rx_thrpt:[]}},chscan:[],proxy:null};!function($){$.url={get:function(key){var reg=new RegExp("(^|&)"+key+"=([^&]*)(&|$)"),r=window.location.search.substr(1).match(reg);return null!=r?unescape(r[2]):null},"goto":function(url,reason){confirm("Will leave current page due to "+reason)&&$(window.location).attr("href",url)},check:function(url,reason){store.offlineCounter==store.offlineCounterBar&&$.url["goto"](url,reason)},reload:function(){window.location.reload()},close:function(){window.opener=null,window.open(".","_self"),window.close(),window&&(window.location.href="about: blank")}}}(jQuery),function($){$.materialize={init:function(){$(".modal").modal()},toast:function(msg,timeout){if(msg&&msg.length>0){var $toastContent=$("<span>"+msg+"</span>");Materialize.toast($toastContent,timeout||3e3)}}}}(jQuery),function($){$.flot={init:function(){var flots=$(".qz-chart-holder"),local=flots.first(),local_chart=$.flot.chart["new"](0,local);store.flot.chart.length=0,store.flot.chart.push(local_chart),$.flot.bg(0,local);var chscan_flot=$(".qz-chart-chscan-holder"),chscan_chart=$.flot.chart.scan(chscan_flot);store.flot.chart_chscan=chscan_chart},bg:function(idx,item){var color=$.flot.color(idx)||"cyan";"object"==typeof item&&item.addClass(color).resize(function(){store.debug&&console.log("Flot Chart(s) resized.")})},chart:{"new":function(idx,item){var data=[{label:"< 噪声 (dBm)",data:[],color:"navy"},{label:"> 无线发送(Mbps)",data:[],color:"deeppink"},{label:"> 无线接收(Mbps)",data:[],color:"magenta"},{label:"> 有线发送(Mbps)",data:[],color:"forestgreen"},{label:"> 有线接收(Mbps)",data:[],color:"gold"}],flot=$.plot(item,data,{series:{lines:{show:!0},shadowSize:0},crosshair:{mode:"y"},xaxis:{show:!0,tickDecimals:0,min:-59,max:0},yaxes:[{show:!0,min:0,max:32,steps:!0,position:"right"},{show:!0,tickDecimals:0,min:-110,max:-56}],legend:{position:"nw",show:!0}});return flot},peer:function(item){var data=[{label:"< 信噪比 (db)",data:[],color:"navy"},{label:"> 接收比特率(Mbit/s)",data:[],color:"deeppink"},{label:"> 发送比特率(Mbit/s)",data:[],color:"forestgreen"}],flot=$.plot(item,data,{series:{lines:{show:!0},shadowSize:0},crosshair:{mode:"y"},xaxis:{show:!0,tickDecimals:0,min:-59,max:0},yaxes:[{show:!0,min:0,max:32,steps:!0,position:"right"},{show:!0,tickDecimals:0,min:0,max:64},{show:!1,tickDecimals:0,min:0,max:8,position:"right"}],legend:{show:!0,position:"nw"}});return flot},scan:function(item){var data=[{}],flot=$.plot(item,data,{series:{bars:{show:!0,barWidth:.8},shadowSize:0},crosshair:{mode:"xy"},xaxes:[{show:!0,tickDecimals:0,min:20,max:52,position:"bottom"},{show:!0,tickDecimals:0,min:470,max:720,position:"bottom"}],yaxes:[{show:!0,min:-110,max:-56,position:"left"},{show:!1,min:0,max:64,position:"left"}],legend:{show:!0}});return flot},update:function(flot,data){flot.setData(data),flot.draw()}},one:function(array,val,qty_max){var max=qty_max||store.defaultRecordQty;if(array)for(;array.length>=max;)array.shift();else array=[];return array.push(val),array},color:function(idx){return store.flot.color[idx]},sync:{chscan:function(){var fchart=store.flot.chart_chscan,chscan=store.chscan,fd_chscan=[{label:"Noise (dBm)",data:chscan,color:"navy",xaxis:1,yaxis:2}];$.flot.chart.update(fchart,fd_chscan)},local:function(){var i,j,invalid=store.invalid,fcharts=store.flot.chart,chart=fcharts[0],noise=store.history.local.noise,eth_tx_thrpt=store.history.local.eth_tx_thrpt,eth_rx_thrpt=store.history.local.eth_rx_thrpt,wls_tx_thrpt=store.history.local.wls_tx_thrpt,wls_rx_thrpt=store.history.local.wls_rx_thrpt,fd_noise=[],fd_wls_tx_thrpt=[],fd_wls_rx_thrpt=[],fd_eth_tx_thrpt=[],fd_eth_rx_thrpt=[];if(noise&&noise.length>0)for(i=0,j=noise.length;i<noise.length;i++){var val=noise[i];val>invalid?fd_noise.push([i+1-j,val]):fd_noise.push(null)}if(eth_tx_thrpt&&eth_tx_thrpt.length>0)for(i=0,j=eth_tx_thrpt.length;i<eth_tx_thrpt.length;i++)fd_eth_tx_thrpt.push([i+1-j,eth_tx_thrpt[i]]);if(eth_rx_thrpt&&eth_rx_thrpt.length>0)for(i=0,j=eth_rx_thrpt.length;i<eth_rx_thrpt.length;i++)fd_eth_rx_thrpt.push([i+1-j,eth_rx_thrpt[i]]);if(wls_tx_thrpt&&wls_tx_thrpt.length>0)for(i=0,j=wls_tx_thrpt.length;i<wls_tx_thrpt.length;i++)fd_wls_tx_thrpt.push([i+1-j,wls_tx_thrpt[i]]);if(wls_rx_thrpt&&wls_rx_thrpt.length>0)for(i=0,j=wls_rx_thrpt.length;i<wls_rx_thrpt.length;i++)fd_wls_rx_thrpt.push([i+1-j,wls_rx_thrpt[i]]);var cd=[],_fields=store.flot.fields,_noise={label:"> 噪声",data:fd_noise,yaxis:2,color:"navy"},_eth_tx={label:"< 有线发送速率",data:fd_eth_tx_thrpt,color:"forestgreen"},_eth_rx={label:"< 有线接收速率",data:fd_eth_rx_thrpt,color:"gold"},_wls_tx={label:"< 无线发送速率",data:fd_wls_tx_thrpt,color:"deeppink"},_wls_rx={label:"< 无线接收速率",data:fd_wls_rx_thrpt,color:"magenta"};"eth"==_fields?cd.push(_eth_rx,_eth_tx):"wls"==_fields?cd.push(_wls_rx,_wls_tx):"abb"==_fields?cd.push(_noise):"dfl"==_fields?cd.push(_noise,_wls_rx,_wls_tx):cd.push(_noise,_wls_rx,_wls_tx,_eth_rx,_eth_tx),$.flot.chart.update(chart,cd)},peers:function(){var peers=(store.invalid,store.history&&"peers"in store.history?store.history.peers:null),peers_qty=peers?peers.length:0,fcharts=store.flot.chart,fcharts_qty=fcharts.length,fcharts_to_gap=peers_qty-(fcharts_qty-1);if(fcharts_to_gap>0?$.flot.peers.add(fcharts_to_gap,fcharts_qty):0>fcharts_to_gap&&$.flot.peers.del(fcharts_to_gap),1>peers_qty)$.html.abb.peer.offline();else{var i,history=store&&"history"in store?store.history:null,peers_cache=history&&"peers"in history?history.peers:null;for(i=0;peers_qty>i;i++){var peer_chart=fcharts[i+1],peer_cache=peers_cache&&peers_cache.length>i?peers_cache[i]:null;peer_cache&&peer_chart&&$.flot.peers.update(i,peer_cache,peer_chart)}}}},peers:{add:function(fcharts_to_gap,fcharts_qty){var i,fchart_color_idx=fcharts_qty-1;for(i=1;fcharts_to_gap>=i;i++){var color=store.flot.color[fchart_color_idx+i];$.html.abb.peer.add();var flot_box=$(".qz-chart-holder").last().addClass(color),flot=$.flot.chart.peer(flot_box);store.flot.chart.push(flot)}},del:function(fcharts_to_gap){var i,gap=0-fcharts_to_gap;for(i=0;gap>i;i++){var _fchart=store.flot.chart.pop();$.flot.destroy(_fchart),$.html.abb.peer.del()}},update:function(idx,peer_cache,peer_chart){var _peer_cd,invalid=store.invalid,_rx_br=[],_rx_mcs=[],_tx_br=[],_tx_mcs=[],_snr_fd=[],rx_br=peer_cache&&"rx_br"in peer_cache?peer_cache.rx_br:null,rx_mcs=peer_cache&&"rx_mcs"in peer_cache?peer_cache.rx_mcs:null,tx_br=peer_cache&&"tx_br"in peer_cache?peer_cache.tx_br:null,tx_mcs=peer_cache&&"tx_mcs"in peer_cache?peer_cache.tx_mcs:null,snr=peer_cache&&"snr"in peer_cache?peer_cache.snr:null;if(rx_br&&rx_br.length>0)for(i=0,j=rx_br.length;i<rx_br.length;i++){var val=rx_br[i];val>invalid?_rx_br.push([i+1-j,val]):_rx_br.push(null)}if(rx_mcs&&rx_mcs.length>0)for(i=0,j=rx_mcs.length;i<rx_mcs.length;i++){var val=rx_mcs[i];val>invalid?_rx_mcs.push([i+1-j,val]):_rx_mcs.push(null)}if(tx_br&&tx_br.length>0)for(i=0,j=tx_br.length;i<tx_br.length;i++){var val=tx_br[i];val>invalid?_tx_br.push([i+1-j,val]):_tx_br.push(null)}if(tx_mcs&&tx_mcs.length>0)for(i=0,j=tx_mcs.length;i<tx_mcs.length;i++){var val=tx_mcs[i];val>invalid?_tx_mcs.push([i+1-j,val]):_tx_mcs.push(null)}if(snr&&snr.length>0)for(i=0,j=snr.length;i<snr.length;i++){var val=snr[i];val>invalid?_snr_fd.push([i+1-j,val]):_snr_fd.push(null)}_peer_cd=[{label:"< 接收比特率(Mbit/s)",data:_rx_br,color:"deeppink"},{label:"< 发送比特率(Mbit/s)",data:_tx_br,color:"forestgreen"},{label:"> 信噪比(db)",data:_snr_fd,yaxis:2,color:"navy"}],$.flot.chart.update(peer_chart,_peer_cd)}},update:function(){$.flot.sync.local(),$.flot.sync.peers()},destroy:function(chart){chart.destroy()}}}(jQuery),function($){$.html={abb:{peer:{add:function(){var _h1=$.html.abb.peer_html["new"](),_h2=$("#qz-peers").html();$("#qz-peers").html(_h2+_h1),$.ops.bind.peer_btn(),$("#qz-peers-none").remove()},del:function(){$(".qz-peer-chart-n").last().remove()},offline:function(){var _h=$.html.abb.peer_html.empty();$("#qz-peers").html(_h)}},peer_html:{"new":function(){return'<div class="col s12 qz-peer-chart-n"> 	<div class="card"> 		<div class="card-image waves-effect waves-block waves-light"> 			<div class="qz-space"> 				<div class="qz-chart-holder qz-chart-peer lighten-5"></div> 			</div> 		</div> 		<!--<div class="card-reveal"> 			<span class="card-title grey-text text-darken-4">射频参数<i class="material-icons right">.</i></span> 				<ul class="collection"> 					<li class="collection-item"><span class="badge qz-peer-txpwr">...</span>发射功率</li> 					<li class="collection-item"><span class="badge qz-peer-rxg">...</span>接收增益</li> 					<li class="collection-item"><span class="badge qz-peer-rxagc">...</span>自动增益控制AGC</li> 					<li class="collection-item"><span class="badge qz-peer-tpc">...</span>发射功率控制TPC</li> 					<li class="collection-item"><span class="badge qz-peer-atf">...</span>ATF</li> 					<li class="collection-item"><span class="badge qz-peer-tdma">...</span>TDMA</li> 				</ul> 		</div>--> 		<div class="card-action"> 			<span class="qz-peer-name">...</span> 			<!--<p class="qz-peer-desc">...</p> 			<a href="#model_proxy_leagal" class="qz-btn-peer-proxy" alt="">管理</a>--> 		</div> 	</div> </div>'},empty:function(){return'<div id="qz-peers-none" class="col s12 section">( 暂未连接 )</div>'}}}}}(jQuery);
